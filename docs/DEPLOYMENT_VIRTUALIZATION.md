# Развёртывание в системах виртуализации

Рекомендации по развёртыванию SigNoz (коллектор и при необходимости self-hosted SigNoz) в различных платформах виртуализации. **Основной акцент — VMware (vSphere/ESXi)**; также кратко рассмотрены Hyper-V, KVM и облака.

---

## VMware (vSphere / ESXi)

### Обзор

- **ESXi** — гипервизор на каждом хосте.
- **vCenter** — централизованное управление хостами, сетью, хранилищем и ВМ.
- ВМ могут быть Linux или Windows; коллектор и приложения обычно разворачиваются внутри ВМ или в отдельной ВМ.

### Архитектура вариантов

1. **Коллектор в отдельной ВМ**  
   Одна ВМ с OpenTelemetry Collector; все приложения в других ВМ шлют телеметрию на эту ВМ (OTLP 4317/4318). SigNoz — Cloud или отдельная ВМ/кластер.

2. **Коллектор на каждой ВМ с приложениями**  
   В каждой ВМ свой коллектор (бинарник или Docker); все коллекторы отправляют данные в один SigNoz. Подходит при строгой сетевой изоляции между ВМ.

3. **SigNoz self-hosted в VMware**  
   Отдельная ВМ или несколько ВМ (например, под Kubernetes) для SigNoz; коллекторы направляют данные в этот инстанс.

### Сеть и порты

- На vSwitch/стандартном коммутаторе или NSX обеспечьте доступ:
  - **4317** (OTLP gRPC) и **4318** (OTLP HTTP) — между ВМ с приложениями и ВМ с коллектором (или между коллектором и SigNoz).
- Группы портов / firewall: разрешить исходящий трафик с ВМ-коллектора к SigNoz Cloud (443) или к ВМ/сервису SigNoz (4317/4318).
- Для доступа к UI SigNoz self-hosted — порт 3301 (по умолчанию) или ваш фронтенд.

### Ресурсы ВМ под коллектор

- **CPU:** 1–2 vCPU достаточно для среднего потока телеметрии.
- **Память:** 512 MiB – 1 GiB (при высокой нагрузке — 2 GiB).
- **Диск:** 10–20 GiB для ОС и логов; буферизация телеметрии в памяти, персистентное хранилище в основном для логов самого коллектора.

### Шаблоны ВМ (VMware)

- Создайте **шаблон ВМ** (Template) с установленным коллектором (бинарник + systemd unit или Docker):
  - Linux: установка по [VM_SETUP.md](VM_SETUP.md), конфиг в `/etc/otelcol-contrib/config.yaml`.
  - В шаблоне не прописывайте endpoint и ключи — только структура конфига; endpoint и ключ задавайте при клонировании (cloud-init, Ansible или скрипт при первом запуске).
- **OVF/OVA:** при экспорте ВМ в OVF/OVA можно распространять предустановленный коллектор; параметризацию (endpoint, ключ) делайте через переменные окружения или подстановку в конфиг при деплое.

### vSphere-специфика

- **Гостевые агенты VMware (VMware Tools):** не заменяют телеметрию приложений; для метрик хоста используйте receiver `hostmetrics` внутри гостевой ОС (как в [INFRASTRUCTURE.md](INFRASTRUCTURE.md)).
- **Снапшоты:** перед обновлением конфига или версии коллектора можно делать снапшот ВМ.
- **vMotion:** при переносе ВМ на другой хост IP и порты не меняются — подключения приложений к коллектору сохраняются.
- **DRS/HA:** при использовании одной ВМ под коллектор учитывайте, что при перезагрузке ВМ телеметрия на время недоступна; для отказоустойчивости рассмотрите два экземпляра коллектора за балансировщиком или отдельный кластер.

### Рекомендуемый порядок (VMware)

1. Создать ВМ (Linux предпочтительно) с достаточными CPU/RAM/диском.
2. Установить OpenTelemetry Collector Contrib по [VM_SETUP.md](VM_SETUP.md).
3. Скопировать `collector/config.vm.yaml` (или `config.full.yaml` без Docker), подставить endpoint и ключ SigNoz.
4. Настроить firewall в гостевой ОС (открыть 4317, 4318).
5. На vSphere проверить, что сетевые профили/правила разрешают трафик между ВМ приложений и ВМ коллектора, а также от коллектора к SigNoz.
6. Запустить коллектор (systemd), убедиться, что сервис в автозагрузке.
7. На ВМ с приложениями задать `OTEL_EXPORTER_OTLP_ENDPOINT=<IP_ВМ_коллектора>:4317` (или :4318 для HTTP).

---

## Другие платформы виртуализации

### Microsoft Hyper-V

- Развёртывание аналогично VMware: ВМ с Linux или Windows, внутри — коллектор (бинарник или Docker).
- Сеть: виртуальные коммутаторы Hyper-V; откройте порты 4317/4318 между ВМ и при необходимости к хосту/внешней сети.
- Шаблоны: можно готовить VHD/VHDX с предустановленным коллектором и параметризировать конфиг при клонировании ВМ.

### KVM / QEMU (Linux)

- ВМ управляются через libvirt (virt-manager, virsh). Коллектор — внутри гостевой ОС.
- Сеть: мосты (bridge) или NAT; те же порты 4317/4318.
- Cloud-init удобен для передачи endpoint и ключа при первом запуске ВМ (избегайте хранения секретов в образах).

### Облака (AWS, Azure, GCP, Oracle Cloud)

- Коллектор можно ставить на **виртуальные машины** облака (аналогично VMware): одна ВМ — коллектор, остальные — приложения.
- Учитывайте security groups / NSG / firewall: разрешить входящий 4317/4318 на ВМ с коллектором и исходящий 443 (или 4317) к SigNoz Cloud или к вашему SigNoz в облаке.

---

## Общие рекомендации

- **Единый конфиг:** используйте конфиги из `collector/` (config.vm.yaml для «голой» ВМ без Docker), подставляя endpoint и ключ из переменных или скриптов при деплое.
- **Секреты:** не храните ingestion key и пароли в шаблонах ВМ/образов; используйте облачные секреты, конфиг-менеджмент (Ansible, Terraform) или скрипты подготовки при первом запуске.
- **Мониторинг самой ВМ:** host metrics (CPU, память, диск) собираются receiver’ом `hostmetrics` внутри гостевой ОС и отображаются в SigNoz Infrastructure; гипервизор (VMware/Hyper-V) для метрик приложений не обязателен.

Дополнительно: [VM_SETUP.md](VM_SETUP.md) (установка коллектора на одной ВМ), [INFRASTRUCTURE.md](INFRASTRUCTURE.md) (метрики хоста в SigNoz).
