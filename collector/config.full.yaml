# =============================================================================
# OpenTelemetry Collector — полная конфигурация для SigNoz
# Трейсы, метрики, логи приложений (OTLP) + метрики хоста + логи из файлов +
# логи Docker-контейнеров. Подходит для Docker-хоста или VM с приложениями.
#
# Перед использованием замените:
#   - <SIGNOZ_ENDPOINT>  — Cloud: ingest.<REGION>.signoz.cloud:443
#                          Self-Hosted: <host>:4317
#   - <INGESTION_KEY>    — только для SigNoz Cloud (self-hosted — удалите headers)
#   - При необходимости пути в filelog (host logs).
# =============================================================================

receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

  # Метрики хоста (CPU, память, диск, сеть)
  hostmetrics:
    collection_interval: 60s
    scrapers:
      cpu: {}
      disk: {}
      load: {}
      filesystem: {}
      memory: {}
      network: {}
      paging: {}
      process:
        mute_process_name_error: true
        mute_process_exe_error: true
        mute_process_io_error: true
      processes: {}
      system: {}

  # Логи Docker-контейнеров (нужен доступ к /var/lib/docker/containers)
  filelog/docker:
    include: [/var/lib/docker/containers/*/*-json.log]
    poll_interval: 200ms
    start_at: end
    include_file_name: false
    include_file_path: false
    operators:
      - id: container-parser
        type: container
        format: docker
        add_metadata_from_filepath: false

  # Логи с хоста из файлов (настройте include под свой ОС и приложения)
  filelog/host:
    include:
      - /var/log/syslog
      # - /var/log/myapp/*.log
      # Windows (если коллектор на Windows): C:\\Logs\\*.log
    poll_interval: 500ms
    start_at: end
    include_file_name: true
    operators:
      - type: add
        field: resource["log.source"]
        value: "host-file"

processors:
  # Опционально: фильтр логов по уровню (отбросить DEBUG/TRACE) или по error.code —
  # см. processors.log-filtering.yaml и docs/LOGGING_FILTERING.md
  batch: {}
  resourcedetection:
    detectors: [env, system, docker]
    timeout: 5s

exporters:
  otlp:
    endpoint: "<SIGNOZ_ENDPOINT>"
    tls:
      insecure: false
    headers:
      "signoz-ingestion-key": "<INGESTION_KEY>"
  # Для self-hosted без ключа используйте:
  #   endpoint: "signoz:4317"
  #   tls:
  #     insecure: true
  #   и удалите блок headers.

  debug:
    verbosity: normal

extensions:
  health_check:
    endpoint: 0.0.0.0:13133
  pprof:
    endpoint: 0.0.0.0:1777
  zpages:
    endpoint: 0.0.0.0:55679

service:
  extensions: [health_check, pprof, zpages]
  pipelines:
    traces:
      receivers: [otlp]
      processors: [resourcedetection, batch]
      exporters: [otlp]
    metrics:
      receivers: [otlp, hostmetrics]
      processors: [resourcedetection, batch]
      exporters: [otlp]
    logs:
      receivers: [otlp, filelog/docker, filelog/host]
      processors: [resourcedetection, batch]
      exporters: [otlp]
